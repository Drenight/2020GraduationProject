<!DOCTYPE html>
<html>
    <head>
		<title>在线语料标注</title>
		<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
		<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	</head>
    <body>

		<p id=cnt></p>
		<button id="dataFileCount">查看已标注文件数量</button>
		<button id="tagFileCount">查看标注篇章结构树数量</button>

		<br>----------------------------------------------------------------------<br>
		<input type="text" name="fileName" id="fileName">想查看的文件名字<br>
		/data:已标注文件<br>
		/tag:可视化标注的篇章结构树<br>

		例：/data/chtb_0001.xml<br>
		<button id="showFile">查看文件</button>
		<br>
		<!--<xmp><p id=fileText></p></xmp>-->
		<xmp id=fileText></xmp>
		<br>----------------------------------------------------------------------<br>
	
		<button id="buildTree">展示该语料篇章结构树</button>
		<img src="" id="b64"/>
		<br>----------------------------------------------------------------------<br>
		控制台有本次标注结果可供参考<br>
		<input type="text" name="tagSave" id="tagSave">标注结果提交路径<br>
		例：/tag/chtb_0001_1627407027.xml<br>
		<button id="saveFile">提交文件</button>
		<br>

		<input type="text" name="nodeCnt" id="nodeCnt">段落数<br>
		<input type="text" name="func" id="func">function<br>
		<input type="text" name="RelWei" id="RelWie">关系权重(默认为0)<br>
		<select id="WeiAt">
			<option value=1>1</option>
			<option value=2>2</option>
			<option value=3>3</option>
		</select>关系重心(第几个被选中,3为全选,相邻段落请先选小的，用这个调节关系重心)
		<br>


		<button id="nodeCreate">生成段落叶子节点</button>
		<button id="reset">重置</button>
		<select id="rela">
			<option value=1>解说关系</option>	
			<option value=2>并列关系</option>
			<option value=3>评价关系</option>
			<option value=4>目的行为关系</option>
			<option value=5>行为目的关系</option>
			<option value=6>因果关系</option>			
			<option value=7>果因关系</option>			
			<option value=8>陈述举例关系</option>			
			<option value=9>举例陈述关系</option>			
			<option value=10>背景关系</option>
			<option value=11>顺承关系</option>			
			<option value=12>递进关系</option>			
			<option value=13>对比关系</option>			
			<option value=14>总结关系</option>			
			<option value=15>补充关系</option>
		</select>
		<button id="connect">连接</button>
	
		<br>
		<div id="pad">
		</div>
		<br>
	</body>
	

	<!-----------------------------------script-------------------------------------->
	

	<script>
		var parCnt=0;		//段落数
		var nodeCnt=0;		//非段落节点数
		var nodeLocking=[];
	
		var svgContainer=d3.select("#pad").append("svg")	//body
			.attr("position","absolute")
			.attr("left",0)
			.attr("top",0)
			.attr("width",5000)
			.attr("height",5000)
			.attr("z-index",-1)
			;
		
		var stk=[];	//存关系节点

		//Center,ChildList,_Function,ID,Layer,ParagraphPosition,ParentId,RelationNumber,RelationType,RelationWeight,StructType)		关系节点

		$("#connect").click(function(){
			var minX=document.getElementById(window.nodeLocking[0]).offsetTop;
			var maxX=document.getElementById(window.nodeLocking[0]).offsetTop;
			var maxY=document.getElementById(window.nodeLocking[0]).offsetLeft;

			//console.log(minX);	

			for(var i=0;i<window.nodeLocking.length;i++){
				minX=Math.min(minX,document.getElementById(window.nodeLocking[i]).offsetTop);
				maxX=Math.max(maxX,document.getElementById(window.nodeLocking[i]).offsetTop);
				maxY=Math.max(maxY,document.getElementById(window.nodeLocking[i]).offsetLeft);
			}

			//创建新按钮
			var o=document.createElement("input");
			o.type="button";
			nodeCnt++;																	//++
			o.id="nod"+nodeCnt;
			o.value=$("#rela option:selected").text();
			o.addEventListener("click",choose);
			o.style.borderColor='#000';
			document.getElementById("pad").appendChild(o);
			o.style.position="absolute";
			ool=maxY+200;
			oot=(minX+maxX)/2;
			o.style.left=(maxY+200)+"px";
			o.style.top=((minX+maxX)/2)+"px";

			//画线
			for(var i=0;i<window.nodeLocking.length;i++){
				var biasTop=document.getElementById("nodeCreate").offsetTop+30;
				svgContainer.append("line")
					.attr("position","absolute")
					.attr("z-index",-1)
					.attr("x1",ool)
					.attr("y1",oot-biasTop)
					.attr("x2",document.getElementById(window.nodeLocking[i]).offsetLeft)
					.attr("y2",document.getElementById(window.nodeLocking[i]).offsetTop-biasTop)
					.attr("stroke","black")
					.attr("stroke-width","2px");
			}
//////////////////////////////////////////////////////////////////////////////////////////////////////
			
			var json={
				"Center":"",
				"ChildList":"",
				"_Function":"",
				"ID":"",
				"Layer":"",
				"ParagraphPosition":"",
				"ParentId":"",
				"RelationNumber":"",
				"RelationType":"",
				"RelationWeight":"",
				"StructType":""
			};
			console.log(stk);
			//Center
			json.Center=""+$("#WeiAt option:selected").text();

			//ChildList
			var flagCL=0;
			for(var i=0;i<window.nodeLocking.length;i++){
				if(document.getElementById(window.nodeLocking[i]).id[0]=='p'){
					var tmp=document.getElementById(window.nodeLocking[i]).id.slice(3);
					if(flagCL){
						json.ChildList+='|';
					}

					json.ChildList+=(tmp);						
					flagCL=1;
				}else{
					//只存段落
				}
			}	
			if(json.ChildList.length==0){
				json.ChildList="null";
			}

			//Function
			json._Function=document.getElementById("func").value+"";

			//ID
			json.ID=o.id.slice(3);

			//Layer
			var mxLayer=1;
			for(var i=0;i<window.nodeLocking.length;i++){
				if(document.getElementById(window.nodeLocking[i]).id[0]=='p'){
					continue;
				}else{
					for(var j=0;j<nodeCnt-1;j++){
						if(window.stk[j].ID==document.getElementById(window.nodeLocking[i]).id.slice(3)){
							mxLayer=Math.max(mxLayer,Number(window.stk[j].Layer));
						}
					}
				}
			}
			json.Layer=mxLayer+1+"";

			//ParagraphPosition
			var flagPP=0;
			for(var i=0;i<window.nodeLocking.length;i++){
				if(document.getElementById(window.nodeLocking[i]).id[0]=='p'){
					var tmp=document.getElementById(window.nodeLocking[i]).id.slice(3);
					if(flagPP){
						json.ParagraphPosition+="|";
					}
					json.ParagraphPosition+=(tmp+"..."+tmp);						
					flagPP=1;
				}else{
					for(var j=0;j<nodeCnt-1;j++){
						if(window.stk[j].ID==document.getElementById(window.nodeLocking[i]).id.slice(3)){
							tmp1=window.stk[j].ParagraphPosition[0];
							tmp2=window.stk[j].ParagraphPosition[window.stk[j].ParagraphPosition.length-1];
							var len=json.ParagraphPosition.length;
							if(tmp1 == json.ParagraphPosition[len-1]){
								json.ParagraphPosition[len-1]=tmp2;
							}else{
								if(flagPP){
									json.ParagraphPosition+="|";
								}
								json.ParagraphPosition+=tmp1+"..."+tmp2;
							}

							flagPP=1;
						}
					}
				}
			}

			//ParentId
			json.ParentId=-1+"";
			for(var i=0;i<window.nodeLocking.length;i++){
				if(document.getElementById(window.nodeLocking[i]).id[0]=='p'){
					//段落不需要
				}else{
					for(var j=0;j<nodeCnt-1;j++){
						if(window.stk[j].ID==document.getElementById(window.nodeLocking[i]).id.slice(3)){
							window.stk[j].ParentId=json.ID+"";
						}
					}
				}
			}

			//RelationNumber
			json.RelationNumber="单个关系";

			//RelationType
			json.RelationType=$("#rela option:selected").text();
			
			//RelationWeight
			json.RelationWeight=document.getElementById("Relwie")+"";
			if(json.RelationWeight == "null"){
				json.RelationWeight="0";
			}

			//StructType
			if($("#rela option:selected").text() == "并列关系"){
				json.StructType="并列切分";
			}else{
				json.StructType="逐层切分";
			}

			window.stk.push(json);
			console.log(json);
//////////////////////////////////////////////////////////////////////////////////////////////////////
			//清除选中状态
			for(var i=0;i<window.nodeLocking.length;i++){
				document.getElementById(window.nodeLocking[i]).style.borderColor="#000";
			}	
			window.nodeLocking.splice(0);
			o=null;
		});

		$("#nodeCreate").click(function(){
			var bs=document.getElementById("nodeCnt").value;
			//console.log(bs);
			window.parCnt=Number(bs);

			var nx=document.getElementById("nodeCreate").offsetTop;

			for(var i=1;i<=Number(bs);i++){
				var o=document.createElement("input");
				o.type="button";
				o.id="par"+i;
				o.value="Paragraph"+i;
				o.addEventListener("click",choose);
				o.style.borderColor='#000';
				o.style.position="absolute";
				o.style.left=0;
				o.style.top=(nx + 100*(i))+"px";
				document.getElementById("pad").appendChild(o);

				o=null;
			}
		});
		
		$("#reset").click(function(){
			for(var i=1;i<=window.parCnt;i++){
				var tmp=document.getElementById("par"+i);
				tmp.remove();
			}

			for(var i=1;i<=window.nodeCnt;i++){
				var tmp=document.getElementById("nod"+i);
				tmp.remove();
			}
			window.parCnt=0;
			window.nodeCnt=0;
			window.nodeLocking.splice(0);
			window.stk.splice(0);
		
			svgContainer.selectAll("*").remove();
		
		});
	
		function choose(){			//ok!
			if(this.style.borderColor=="red"){
				this.style.borderColor="#000";
				for(var i=0;i<window.nodeLocking.length;i++){
					if(window.nodeLocking[i]==this.id){
						window.nodeLocking.splice(i,1);
					}
				}
			}else{
				this.style.borderColor="red";
				window.nodeLocking.push(this.id);
				//console.log(this.id);
			}
			//console.log(window.nodeLocking);
		};

		$("#tagFileCount").click(function(){
				$.get("/tagFileCount",function(data,status){
						//返回数据data,返回状态status
						if(status=="success"){
							document.getElementById('cnt').innerHTML="篇章结构树"+data;
						}
				});
		});
		$("#dataFileCount").click(function(){
				$.get("/dataFileCount",function(data,status){
						//返回数据data,返回状态status
						if(status=="success"){
							document.getElementById('cnt').innerHTML="已标注"+data;
						}
				});
		});
		$("#showFile").click(function(){
				var fileName=$("#fileName").val();
				$.get("/showFile",{message:fileName},function(data,status){
						if(status=="success"){
							document.getElementById('fileText').innerHTML=data;
						}
						else{
							alert("Ajax 失败");
						}
				});
		});

		$("#saveFile").click(function(){
				var fileName=$("#tagSave").val();
				var ans="";
				mxLayer=window.stk[0].Layer
				for(var i=0;i<window.stk.length;i++){
					if(i!=0){ans+="#";}
					ans+=JSON.stringify(window.stk[i]);
					mxLayer=Math.max(mxLayer,Number(window.stk[i].Layer));
				}
				var json={
					"fileName":fileName,
					"ans":ans,
					"nodeCnt":window.nodeCnt,
					"mxLayer":mxLayer,
				};

				$.post("/tagSave",json,function(data,status){
						if(status=="success"){
							alert("success");
						}
						else{
							alert("Ajax 失败");
						}
				});
		});


		$("#buildTree").click(function(){
						$.get("/buildTree",function(data,status){
						//返回数据data,返回状态status
						if(status=="success"){
							document.getElementById('b64').src='data:image/png;base64,'+data;
						}
						else{
							alert("Ajax 失败");
						}			
								
				});
		});
	
	</script>	
</html>
